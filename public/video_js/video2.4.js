define(function(require){function a(a){location.href=a}function c(){var a=$(".J-chaptername").data("id");return $("[data-id="+a+"]")}require("/static/lib/mocoplayer/2.4/mocoplayer"),require("/static/page/course/common/jquery.nanoscroller.js"),require("/static/page/course/common/drag.js");var g=require("store"),h=require("./common/animate-achievement"),v=require("/static/page/course/common/course_detail_common.js"),y=require("../common/verify-code.js"),w=require("/static/component/base/util/guideLayer"),b=null,j={getData:function(a,c,g){var h=this;$.ajax({type:"GET",url:"/course/"+a,data:{cid:course_id},dataType:"json",success:function(a){if(0==a.result){var v=a.data;v.length&&(h.bindData(v.slice(0,2),c[0],g[0]),h.bindData(v.slice(2,5),c[1],g[1]))}}})},bindData:function(a,c,g){var h,v,y="",w="";$(a).each(function(c){2==a[c].type?(h="//coding.imooc.com/class/"+a[c].id+".html",v=a[c].pic):(h="/learn/"+a[c].id,v="//img.mukewang.com/"+a[c].pic+"-240-135.jpg"),w+='<li class="l">                            <a href="'+h+'" target="_blank">                                <img src="'+v+'"/>                            </a>                            <a href="'+h+'" target="_blank" class="recom-course-title">                            	'+a[c].name+"                            </a>                        </li>"}),"first-row"==c?(y='<ul class="l">	                        '+w+"	                    </ul>",$(g).before(y)):(y='<div class="recom-course-row">            				<ul class="clearfix">	                        	'+w+"		                    </ul>		                </div>",$(g).after(y))}};j.getData("ajaxlastmediarecom",["first-row","second-row"],[".first-row .other-oper",".first-row"]);var C={scrollTo:c()};$(function(){function c(){if("number"!=typeof continueTime){continueTime=0;var a=g.get("_vt");a&&a[pageInfo.mid]&&(continueTime=a[pageInfo.mid].st||0)}j(continueTime)}function j(c){var g=!1;window.thePlayer=mocoplayer($("#video-box"),{url:"http://www.imooc.com/course/playlist/"+pageInfo.mid+"?t=m3u8",title:videoTitle,currentTime:c,events:{onReady:function(){this.play()},onComplete:function(){window.clearInterval(b),g=!0,b=null;var c=$(".J_next-box"),h=c.find(".J-next-course");if(c.removeClass("hide"),k(),h.length){var v=$(".J-next-btn"),y=h.data("next-src");v.removeClass("hide").on("click",function(){a(y)})}},onError:function(){}}})}function T(a){"string"==typeof a&&(a=$.parseJSON(a)),0==a.result?P.screenShotFlashBack(a):alert(a.msg||"错误，请稍后重试")}if(isLogin){var _=g.get("isFirstVisit")||"Yes";"Yes"===_?w.create(function(){c()}):c()}$(window).on("beforeunload",function(){function a(){var g,h,i=0,v=(new Date).getTime();for(g in c)i++,c[g].t<v&&(v=c[g].t,h=g);i>=10&&(delete c[h],a())}var c=g.get("_vt")||{},h=c[pageInfo.mid];if(thePlayer.getCurrentTime)return $(".J_next-box").hasClass("hide")?void(h?(h.t=(new Date).getTime(),h.st=thePlayer.getCurrentTime(),g.set("_vt",c)):(h={t:(new Date).getTime(),st:thePlayer.getCurrentTime()},a(),c[pageInfo.mid]=h,g.set("_vt",c))):(delete c[pageInfo.mid],void g.set("_vt",c))});var k=function(){if(OP_CONFIG.userInfo){var a,c={},g=0,v=(new Date).getTime();return c.mid=pageInfo.mid,b=window.setInterval(a=function(){var a,y;"object"==typeof thePlayer&&thePlayer.getCurrentTime&&(a=(new Date).getTime(),y=parseInt(a-v)/1e3,c.time=y-g,c.learn_time=thePlayer.getCurrentTime(),$.ajax({url:"/course/ajaxmediauser/",data:c,type:"POST",dataType:"json",success:function(a){if("0"==a.result){g=y;var c=a.data.media,v=a.data.course,a=[];c&&a.push({mp:c.mp.point,desc:c.mp.desc}),v&&a.push({mp:v.mp.point,desc:v.mp.desc}),h(a),c&&$("#J_ques_pop").show()}else"-105002"==a.result&&$.alert("你的账号在另一地点登录，已被强迫下线。",{info:"如果不是本人操作，建议你修改密码。",callback:function(){window.location.href="http://coding.imooc.com"}})}}))},6e4),window.onbeforeunload=function(){var a,h;"object"==typeof thePlayer&&thePlayer.getCurrentTime&&(a=(new Date).getTime(),h=parseInt(a-v)/1e3,c.time=h-g,c.learn_time=thePlayer.getCurrentTime(),$.ajax({url:"/course/ajaxmediauser/",data:c,type:"POST",async:!1,dataType:"json",success:function(a){"0"==a.result&&(g=h)}}))},a}}();window.screenReceive=T,$.each("qa,note".split(","),function(a,c){v.remote[c].extendMethod("reset",function(){P.reset(".js-shot-video[data-type='"+c+"']")})});var P={screenShot:function(a){var c=$(a),g=0;thePlayer.getCurrentTime&&(g=Math.round(thePlayer.getCurrentTime()));var h;h="",this.el=a,v.remote[c.attr("data-type")].set("video",h),v.remote[c.attr("data-type")].set("picture_time",g)},formatSecond:function(a){function c(a){return 10>a?"0"+a:a}var g=c(parseInt(a/60))+":"+c(a%60);return g},reset:function(a,c){var g=$(a);this.el=null,c&&v.remote[g.attr("data-type")].reset()},screenShotFlashBack:function(){!this.el}};$(document).on("click","#js-discuss-submit",function(){var a,c,g,h,w={},b=$(this);if($(".qa-pop .js-shot-video").hasClass("on")){if(!$(".J_next-box").hasClass("hide")||$(".mocoplayer-error").length)return void $.prompt("请在视频播放时截图！",{icon:"error"});P.screenShot(".qa-pop .js-shot-video")}else P.reset(".qa-pop .js-shot-video",1);if(!b.hasClass("submit-loading")){if(h=$.trim($("#js-qa-title").val()),h.length<5||h===$("#js-qa-title").attr("placeholder"))return void layer.msg("问答标题不能少于5个字",2,-1);if(h.length>255)return void layer.msg("问答标题不能大于255个字",2,-1);if(a=UE.getEditor("discuss-editor").getContent(),a=$.trim(a),c=$.trim(UE.getEditor("discuss-editor").getContentTxt()),g=c.length,0==g||"请输入讨论内容..."==c)return void layer.msg("请输入讨论内容",2,-1);if(5>g)return void layer.msg("输入不能小于5个字符",2,-1);if(a.length>2e4)return void layer.msg("输入不能超过20000个字",2,-1);var j=$.trim(y.getResult(".qa-pop .verify-code"));if(0==j.length)return void $(".qa-pop .verify-code").trigger("fail","请输入验证码");w.verify=j,$(".qa-pop .verify-code").trigger("succ"),$.extend(w,postData),w.content=a,w.title=h,v.remote.qa.prev(w),$(".interal-checked").length&&(w.frommedia=1),b.addClass("submit-loading").val("正在发布..."),$.ajax({url:"/course/ajaxsaveques",data:w,type:"post",dataType:"json",success:function(a){0==a.result?(layer.msg("发布成功!",2,-1),v.tabList.qa.load(),v.remote.qa.reset(),window.qapop.hide(),$("#interal-use").removeClass("interal-checked")):-103002==a.result?($(".qa-pop .verify-code").trigger("fail",a.msg),$(".qa-pop .verify-code-ipt").val(""),$(".qa-pop .js-verify-refresh").click()):layer.msg(a.msg,2,-1)},complete:function(){b.removeClass("submit-loading").val("发布")}})}}),$(document).on("click","#js-note-submit",function(){var a=$(this),c={};if(!a.hasClass("submit-loading")){if($(".note-pop .js-shot-video").hasClass("on")){if(!$(".J_next-box").hasClass("hide")||$(".mocoplayer-error").length)return void $.prompt("请在视频播放时截图！",{icon:"error"});P.screenShot(".note-pop .js-shot-video")}else P.reset(".note-pop .js-shot-video",1);if(0!==$(".publish-note-btns .verify-code-ipt").length){var g=$.trim(y.getResult(".publish-note-btns .verify-code"));if(0==g.length)return void $(".publish-note-btns .verify-code").trigger("fail","请输入验证码");$(".publish-note-btns .verify-code").trigger("succ"),c.verify=g}if(c.content=$("#js-note-textarea").val(),!$.trim(c.content))return void layer.msg("请输入内容",2,-1);var h=c.content.replace(/\s*$/,"").length;if(h>0&&3>h)return void layer.msg("输入不能小于3个字符",2,-1);if(h>1e3)return void layer.msg("输入不能超过1000个字",2,-1);$.extend(c,postData),v.remote.note.prev(c),a.addClass("submit-loading").val("正在保存..."),$.ajax({url:"/course/addnote",type:"post",dataType:"json",data:c,success:function(c){a.removeClass("submit-loading").val("保存"),0==c.result?(layer.msg("发布成功",2,-1),v.tabList.note.load(),v.remote.note.reset(),window.notepop.hide(),$(".js-ower").hasClass("checked")&&($(".js-course-menu").attr("data-ower","all"),$(".js-ower").removeClass("checked")),$(".js-select-state a").removeClass("active"),$(".js-select-state a[data-sort=last]").addClass("active")):1==c.data&&-1==c.result?y.renderVerifyCodeBlock(".publish-note-btns .verify-code","/course/getnotecode"):-103002==c.result?($(".note-pop .verify-code").trigger("fail",c.msg),setTimeout(function(){y.renderVerifyCodeBlock(".publish-note-btns .verify-code","/course/getnotecode")},1e3)):layer.msg(c.msg,2,-1)},error:function(){layer.msg("发布失败",2,-1),a.removeClass("submit-loading").val("保存")}})}}),$("#ques-bd").delegate(".Js-change-ques","click",function(){var a=$("#ques-group li");$(this).parent("li").removeClass("curr");var c,g=$(this).parent("li").index(),h=a.length-1;g===h?a.eq(0).addClass("curr"):$(this).parent("li").next().addClass("curr"),c=$("#ques-group .curr").find(".ques-title").attr("href"),$("#js-to-answer").attr("href",c)}),$("#J_Box").on("click","#J_issue_Close,.ques-title,#js-to-answer",function(){$("#J_ques_pop").hide()}),function(){var a=function(){var a={};return a.resetSize=function(){var a=$(".chapter").hasClass("light");if(a){if($(window).width()>800)var c=$(window).width()-$(".section-list").outerWidth(!0);else var c=800;c+="px"}else var c="100%";var g=$("#header").outerHeight(!0),h=$(".js-course-menu").outerHeight(!0),v=$(window).height()-g-h;$(".js-box-wrap").css("width",c).css("height",v+"px"),v>500?$(".question-tip-layer").css("marginTop","6%"):v>400&&500>v?$(".question-tip-layer").css("marginTop","3%"):400>v&&$(".question-tip-layer").css("marginTop","1%")},a}(),c=function(){{var a=$(".js-course-menu"),c=$(".course-left"),g=c.offset().top,h=c.offset().left;$(".js-fixed-video")}return $(window).on("scroll",function(){var c=$(window).scrollTop();c>=g?a.css("position","fixed").css("left",h+"px"):a.css("position","absolute").css("left",0)}),{setLT:function(){g=c.offset().top,h=c.offset().left}}}();a.resetSize(),$(".nano").nanoScroller(C),c.setLT(),$(window).on("resize",function(){setTimeout(function(){a.resetSize(),$(".nano").nanoScroller(C),c.setLT(),$(window).trigger("scroll")},200)});var g=$(".section-list");$(".chapter").on("click",function(){var c=$(this);c.hasClass("light")?(c.removeClass("light"),g.animate({right:-360},200)):(c.addClass("light"),g.animate({right:0},200)),a.resetSize()})}()})});